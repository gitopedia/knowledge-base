name: Build Knowledgebase Index

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [ content-updated ]

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout Gitopedia content (dispatched)
        if: github.event_name == 'repository_dispatch'
        uses: actions/checkout@v4
        with:
          repository: gitopedia/gitopedia
          path: gitopedia
          fetch-depth: 0
          ref: ${{ github.event.client_payload.gitopedia_sha }}
      - name: Checkout Gitopedia content (default)
        if: github.event_name != 'repository_dispatch'
        uses: actions/checkout@v4
        with:
          repository: gitopedia/gitopedia
          path: gitopedia
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Build index
        env:
          GITOPEDIA_DIR: gitopedia/Compendium
        run: |
          go run cmd/indexer/main.go
      - name: Upload index artifact
        uses: actions/upload-artifact@v4
        with:
          name: index-sqlite
          path: out/index.sqlite

  deploy:
    needs: build-index
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'repository_dispatch'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: index-sqlite
          path: out
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITOPEDIA_KB_ROLE_ARN }}
          aws-region: ${{ secrets.GITOPEDIA_AWS_REGION }}
      - name: Upload index to S3
        run: |
          aws s3 cp out/index.sqlite s3://${{ secrets.GITOPEDIA_KB_INDEX_BUCKET }}/index.sqlite

  dispatch-website:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GITOPEDIA_APP_ID }}
          private_key: ${{ secrets.GITOPEDIA_APP_PRIVATE_KEY }}
      - name: Dispatch to Website (repository_dispatch)
        env:
          SITE_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if [ -z "${SITE_TOKEN}" ]; then
            echo "GitHub App token not available; skipping dispatch to Website." >&2
            exit 0
          fi
          payload=$(jq -n \
            --arg kb_sha "${GITHUB_SHA}" \
            --arg gitopedia_sha "${{ github.event.client_payload.gitopedia_sha || '' }}" \
            '{event_type:"rebuild-site", client_payload:{kb_sha:$kb_sha, gitopedia_sha:$gitopedia_sha}}')
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${SITE_TOKEN}" \
            https://api.github.com/repos/gitopedia/website/dispatches \
            -d "${payload}"
